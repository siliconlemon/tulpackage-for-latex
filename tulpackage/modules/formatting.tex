% tulpackage/modules/formatting.tex
% Popis: Formátování pro nadpisy, obsah (TOC), titulní stranu a prostředí pro výpisy.

% === VYŽADOVANÉ BALÍČKY ===
\RequirePackage{ifthen}
\RequirePackage[sf, bf]{titlesec}
\RequirePackage{tocloft}
\RequirePackage{etoolbox}
\RequirePackage{framed}
\RequirePackage{tabularray}
\RequirePackage{fvextra}    % VYŽADOVÁNO pro zalamování Verbatim

% === OBECNÉ POMOCNÉ MAKRA ===
\providecommand{\oddel}{{\color{\tulcolor}\rule{1pt}{1.7ex}}}
\providecommand{\TUL@headfnt}{\TULHeadFont}
\providecommand{\TUL@TOCtextcolor}{black}

% === OBSAH (TOC) ===
\renewcommand{\cfttoctitlefont}{\color{\titlecolor}\TUL@headfnt\LARGE\raggedright}
\renewcommand{\cftpartfont}{\color{\TUL@TOCtextcolor}}
\renewcommand{\cftloftitlefont}{\color{\TUL@TOCtextcolor}\LARGE\bfseries}
\renewcommand{\cftfigfont}{\color{\TUL@TOCtextcolor}}
\renewcommand{\cfttabfont}{\color{\TUL@TOCtextcolor}}

% Délka: založit jen pokud neexistuje
\ifcsdef{TUL@TOC@skip}{}{%
  \newlength{\TUL@TOC@skip}%
}

\@ifundefined{chapter}{%
    \setlength{\cftbeforetoctitleskip}{2mm}
    \setlength{\cftaftertoctitleskip}{10mm}
    \renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}
    \setlength{\TUL@TOC@skip}{8pt}
}{%
    \setlength{\cftbeforetoctitleskip}{0mm}
    \setlength{\cftaftertoctitleskip}{6mm}
    \renewcommand{\cftchapleader}{\cftdotfill{\cftdotsep}}
    \setlength{\TUL@TOC@skip}{4pt}
    \renewcommand{\cftbeforechapskip}{\TUL@TOC@skip}
}
\renewcommand{\cftbeforesecskip}{\TUL@TOC@skip}
\renewcommand{\cftbeforesubsecskip}{\TUL@TOC@skip}
\renewcommand{\cftbeforesubsubsecskip}{\TUL@TOC@skip}

% Bezpečné patchování: jen pokud existují příslušná makra.
\ifcsdef{l@chapter}{%
  \pretocmd{\l@chapter}{\hypersetup{linkcolor=\TUL@TOCtextcolor}}{}{}%
}{}%
\ifcsdef{l@section}{%
  \pretocmd{\l@section}{\hypersetup{linkcolor=\TUL@TOCtextcolor}}{}{}%
}{}%
\ifcsdef{l@subsection}{%
  \pretocmd{\l@subsection}{\hypersetup{linkcolor=\TUL@TOCtextcolor}}{}{}%
}{}%

% === SEZNAM OBRÁZKŮ A TABULEK ===
\setlength{\cftfigindent}{0pt}
\setlength{\cfttabindent}{0pt}
\renewcommand{\cftfigaftersnum}{:}
\renewcommand{\cfttabaftersnum}{:}

\AtBeginDocument{%
    \ifthenelse{\equal{\TUL@nguage}{EN}}{%
        \renewcommand{\cftfigpresnum}{Figure }%
        \renewcommand{\cfttabpresnum}{Table }%
        \setlength{\cftfignumwidth}{5.5em}%
        \setlength{\cfttabnumwidth}{5.5em}%
    }{%
        \renewcommand{\cftfigpresnum}{Obrázek }%
        \renewcommand{\cfttabpresnum}{Tabulka }%
        \setlength{\cftfignumwidth}{7.5em}%
        \setlength{\cfttabnumwidth}{7.0em}%
    }%
    \renewcommand{\listoffigures}{%
        \phantomsection%
        \ifthenelse{\equal{\TUL@nguage}{EN}}%
        {%
            \section*{\Large List of Figures}%
            \@mkboth{List of Figures}{List of Figures}%
            \addcontentsline{toc}{chapter}{List of Figures}%
        }%
        {%
            \section*{\Large Seznam obrázků}%
            \@mkboth{Seznam obrázků}{Seznam obrázků}%
            \addcontentsline{toc}{chapter}{Seznam obrázků}%
        }%
        \vspace{0.5em}\thispagestyle{plain}%
        {\hypersetup{linkcolor=\TUL@TOCtextcolor}\@starttoc{lof}}\par\vspace{1em}%
    }%
    \renewcommand{\listoftables}{%
        \phantomsection%
        \ifthenelse{\equal{\TUL@nguage}{EN}}%
        {%
            \section*{\Large List of Tables}%
            \@mkboth{List of Tables}{List of Tables}%
            \addcontentsline{toc}{chapter}{List of Tables}%
        }%
        {%
            \section*{\Large Seznam tabulek}%
            \@mkboth{Seznam tabulek}{Seznam tabulek}%
            \addcontentsline{toc}{chapter}{Seznam tabulek}%
        }%
        \vspace{0.5em}\thispagestyle{plain}%
        {\hypersetup{linkcolor=\TUL@TOCtextcolor}\@starttoc{lot}}\par\vspace{1em}%
    }%
}

% === SEZNAM ZKRATEK ===
% Prostředí existuje, pokud existuje makro \abbreviations (a \endabbreviations).
\ifcsdef{abbreviations}{%
  % už je definované -> nedělej nic
}{%
  \newenvironment{abbreviations}{%
      \phantomsection%
      \ifthenelse{\equal{\TUL@nguage}{EN}}%
        {\section*{\Large List of abbreviations}}%
        {\section*{\Large Seznam zkratek}}%
      \vspace{-1em}\thispagestyle{plain}%
      \DefTblrTemplate{contfoot-text}{default}{}%
      \DefTblrTemplate{conthead-text}{default}{}%
      \DefTblrTemplate{contfoot}{default}{}%
      \DefTblrTemplate{conthead}{default}{}%
      \DefTblrTemplate{caption}{default}{}%
      \DefTblrTemplate{capcont}{default}{}%
      \noindent\begin{tblr}[long, entry=none]{column{2}={co=1}}%
  }{%
      \end{tblr}\vspace{1em}%
  }%
}

% === VÝPISY / BLOKY KÓDU ===
% Vynutit zalamování standardních verbatim prostředí
\fvset{breaklines=true, breakanywhere=true}
\RecustomVerbatimEnvironment{verbatim}{Verbatim}{}

\providecommand{\listoflistings}{%
    \phantomsection%
    \ifthenelse{\equal{\TUL@nguage}{EN}}%
    {%
        \section*{\Large List of Listings}%
        \@mkboth{List of Listings}{List of Listings}%
        \addcontentsline{toc}{chapter}{List of Listings}%
    }%
    {%
        \section*{\Large Seznam zdrojových kódů}%
        \@mkboth{Seznam zdrojových kódů}{Seznam zdrojových kódů}%
        \addcontentsline{toc}{chapter}{Seznam zdrojových kódů}%
    }%
    \vspace{0.5em}\thispagestyle{plain}%
    {\hypersetup{linkcolor=\TUL@TOCtextcolor}\@starttoc{lol}}\par\vspace{1em}%
}

\providecommand{\l@tullisting}{%
    \ifthenelse{\equal{\TUL@nguage}{EN}}%
      {\@dottedtocline{0}{0pt}{5.5em}}%
      {\@dottedtocline{0}{0pt}{8.5em}}%
}

% Čítač je globální; pokud už existuje, znovu ho nezakládáme.
\ifcsdef{c@tullisting}{}{%
  \newcounter{tullisting}%
}

\providecommand{\listingcaption}[1]{%
    \par\vspace{-8pt}\refstepcounter{tullisting}%
    \ifthenelse{\equal{\TUL@nguage}{EN}}%
    {%
      \addcontentsline{lol}{tullisting}{\protect\numberline{Listing \thetullisting:}#1}%
      \noindent{Listing \thetullisting:} #1%
    }%
    {%
      \addcontentsline{lol}{tullisting}{\protect\numberline{Zdrojový kód \thetullisting:}#1}%
      \noindent{Zdrojový kód \thetullisting:} #1%
    }%
    \par\vspace{8pt}%
}

% Prostředí
\ifcsdef{myquote}{}{%
  \newenvironment{myquote}{\begin{list}{}{\setlength\leftmargin\parindent}\item[]}{\end{list}}%
}
\ifcsdef{listing}{}{%
  \newenvironment{listing}{\begin{myquote}\color{\tulcolor}}{\end{myquote}}%
}
\ifcsdef{slisting}{}{%
  \newenvironment{slisting}{%
      \vspace{12pt}\begin{myquote}\footnotesize\color{\tulcolor}\raggedright\sloppy%
      \def\FrameCommand##1{\hspace{10pt}##1}%
      \MakeFramed{}{\setlength{\hsize}{\linewidth}\advance\hsize-\width\FrameRestore}%
  }{%
      \endMakeFramed{}\end{myquote}\vspace{0pt}%
  }%
}
\ifcsdef{linelisting}{}{%
  \newenvironment{linelisting}{%
      \vspace{16pt}\begin{myquote}\footnotesize\color{\tulcolor}\raggedright\sloppy%
      \def\FrameCommand##1{\hspace{0pt}{\color{\tulcolor}\vrule width 1.0pt}\hspace{10pt}##1}%
      \MakeFramed{}{\setlength{\hsize}{\linewidth}\advance\hsize-\width\FrameRestore}%
  }{%
      \endMakeFramed{}\end{myquote}\vspace{0pt}%
  }%
}

% === TITULNÍ STRANY A FORMÁTOVÁNÍ NADPISŮ ===
\providecommand{\create@uthb@x}[2]{\vspace{20mm}{\Large #1}\\\vspace{5mm}{\large #2}\par}

% Délka pro výpočet řádkování na titulní straně
\ifcsdef{f@ntsize}{}{%
  \newlength{\f@ntsize}%
}
\setlength{\f@ntsize}{\f@size pt}

\providecommand{\TULtitlepage}[3]{{%
    \thispagestyle{TULheaderonly}\mbox{}\vfill\vfill\vfill\bgroup\raggedright%
    \color{\tulcolor}\huge\bfseries\TULmono\setlength{\baselineskip}{2.5\f@ntsize} #1\par%
    \create@uthb@x{#2}{#3}\egroup\vfill\newpage%
}}

\providecommand{\TULfancytitlepage}[3]{{%
    \thispagestyle{TULheaderonly}\pagecolor{\tulcolor}\darkTULbg\mbox{}\vfill\vfill\vfill\bgroup\raggedright%
    \color{white}\huge\TULFancyFont\setlength{\baselineskip}{2.5\f@ntsize} #1\par%
    \create@uthb@x{#2}{#3}\egroup\vfill\newpage\pagecolor{white}%
}}

% Pozn.: oprava zjevné chyby – původně se testovalo \subsection, ale formátovalo \subsubsection.
\providecommand{\setup@TUL@titleformats}{%
    \def\setupTitleFormat##1##2##3##4{%
        \ifthenelse{\boolean{TUL@numbering}}%
        {\titleformat{##1}{\color{\titlecolor}\TUL@headfnt##2\raggedright}{##3}{1em}{}}%
        {\titleformat{##1}{\color{\titlecolor}\TUL@headfnt##2\raggedright}{}{0pt}{}}%
    }%
    \ifcsname chapter\endcsname\setupTitleFormat{\chapter}{\LARGE}{\thechapter}{}\fi % chktex 1
    \ifcsname section\endcsname\setupTitleFormat{\section}{\Large}{\thesection}{}\fi % chktex 1
    \ifcsname subsection\endcsname\setupTitleFormat{\subsection}{\large}{\thesubsection}{}\fi % chktex 1
    \ifcsname subsubsection\endcsname\setupTitleFormat{\subsubsection}{\normalsize}{\thesubsubsection}{}\fi % chktex 1
    \ifcsname paragraph\endcsname\titleformat{\paragraph}{\color{\titlecolor}\TUL@headfnt\normalsize\raggedright}{}{0pt}{}\fi % chktex 1
}
